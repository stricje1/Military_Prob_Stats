---
title: "Nile River Flow"
author: "Dr. Jeff Strickland"
date: "2024-11-16"
output: word_document
---

```{r setup, include=FALSE, fig.width = 8, fig.height = 6, dpi=330}
knitr::opts_chunk$set(echo = TRUE)
```

### Vignette 33 (Managing River Water Flow) Regression
Recall the vignette for the Nile River flowing from Sudan into Egypt and eventually into the Mediterranean Sea. The Aswan High Dam, situated at the northern end of Lake Nasser, controls the flow of water into the fertile regions bordering the Nile River in Egypt and to important metropolitan areas such as Cairo. Proper control of the water passing through the dam is critical to the well-being of agriculture, industry, and population centers.

The amount of water that the dam engineers can prudently allow to flow through the dam depends upon the amount of water reserves in Lake Nasser, which in turn depends upon the flow of water into the lake at Wadi Halfa. In this respect it is very useful to be able to predict the future Nile River flowrates at Wadi Halfa using historical data of inflow for over 100 years.

#### Loading the Data

```{r}
nile <-read.csv("C:\\Users\\jeff\\OneDrive\\Books\\Prob and Stats\\Data\\nile.csv")
```

#### Generating a Scatterplot

Here, we generate a scatterplot of flow rates using the `geom_point` function from the `ggplot` package. Notice the poitive sloped linear pattern.

```{r pressure, echo=FALSE}
library(ggplot2)
ggplot(nile, aes(x = January, y = February)) +
  geom_point(size=3, shape=16, col='dodgerblue') +
  labs(title = "Nile River Inflow",
       x = "",
       y = "") +
  theme(axis.line = element_line(arrow = arrow(angle = 30,
        length = unit(0.15, "inches"),
        ends = "last",type = "closed")))
```

#### Data Summary

Now, we build a custom summary table.

```{r, echo = FALSE}
results <- data.frame(cbind(
  rbind("n", 
        "Sample Mean",
        "Sample Stdev",
        "Sample Var",
        "Minimum",
        "Lower Quartile",
        "Median",
        "Lower Quartile",
        "Maximum"),  
  rbind(nrow(nile),
        round(mean(nile$January),4),
        round(sd(nile$January),4),
        round(var(nile$January),4),
        round(min(nile$January),4),
        round(quantile(nile$January,1/4),4),
        round(median(nile$January),4),
        round(quantile(nile$January,3/4),4),
        round(max(nile$January),4)),
  rbind(nrow(nile),
        round(mean(nile$February),4),
        round(sd(nile$February),4),
        round(var(nile$February),4),
        round(min(nile$February),4),
        round(quantile(nile$February,1/4),4),
        round(median(nile$February),4),
        round(quantile(nile$February,3/4),4),
        round(max(nile$February),4))
  ))

names(results)[1] <- "Statistic"
names(results)[2] <- "January"
names(results)[3] <- "February"

#results

library(knitr)
knitr::kable(results[,1:3], "pipe")
```

#### Fit a Regression Model

Here, we use the R `lm` function from the `stats` package to predict future Nile flow rates, with a upper an lower confidence interval, using the `confint` function.

```{r}
model01 <- lm(January~February, data = nile)
summary(model01)
model01$coefficients
confint(model01)
```

Lower 2.5%  2.5 CI is 1.008440 $\pm$
The 2.5 CI is 1.041705 $\pm$

```{r}
library(ggplot2)
# Change the point colors and shapes
# Change the line type and color
ggplot(nile, aes(x = January, y = February)) + 
  geom_point(shape=20, color="red3", size = 3)+
  geom_smooth(method=lm, se=FALSE, linetype="solid",
             color="blue")
# Change the confidence interval fill color
ggplot(nile, aes(x = January, y = February)) + 
  geom_point(shape=20, color="blue", size=3)+
  geom_smooth(method=lm,  linetype="solid",
             color="red3", fill="dodgerblue")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
nile.mod <- lm(January ~ February, data = nile)
nile.mod.prd <- predict(nile.mod, interval = "conf")
nile.prd <- cbind(nile, nile.mod.prd)
head(nile.prd,10)
```

### Regression Model Prediction Intervals

Here, we use the R predict function from the `stats` package to predict future Nile flow rates, with a upper an lower prediction interval.

```{r}
nile <-read.csv("C:\\Users\\jeff\\OneDrive\\Books\\Prob and Stats\\Data\\nile.csv")
fm1 <- lm(January~February, data = nile)
fm1.prd.int <- predict(fm1, interval = "pred")
nile.dat.prd <- cbind(nile, fm1.prd.int)
head(nile.dat.prd,10)
```


```{r}
ggplot(data = nile.dat.prd, aes(x = February, y = January)) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "deepskyblue4", alpha = 0.2) + 
  geom_ribbon(aes(ymin = nile.prd$lwr, ymax = nile.prd$upr), fill = "deepskyblue", alpha = 0.6) + 
  geom_line(aes(y = fit), color = "white", size = 1.5) +
  geom_point(size = 2, col = 'red3') + 
  ggtitle("Regression Line, 95% Confidence and Prediction Bands")
```

#### Residual Analysis

First, we make a residuals versus fitted values plot plot and note its random pattern. The plot implies that the model's linear assumption is valid.

```{r}
ggplot(model01, aes(x = .fitted, y = .resid)) +
  geom_point(col = 'red4', size = 2) +
  geom_hline(yintercept = 0) +
  labs(title = "Nile River Inflow Model Residuals",
       x = "Fitted Values",   y = "Residuals") +
  theme(axis.line = element_line(arrow = arrow(angle = 15,
        length = unit(0.15, "inches"),
        ends = "last",type = "closed")))
```

Finally, we make a normal probability plot and note its near linear pattern, indicating the validity of the normality assumption.

```{r}
# importing libraries
library(qqplotr)
 
# plotting data with proper labels 
# And adding line with proper properties
nile.stdres = rstandard(nile.mod)
ggplot(mapping = aes(sample = nile.stdres)) +
   stat_qq_point(size = 2,color = "red2") +
   stat_qq_line(color="dodgerblue", size = 1.5) + 
   ggtitle("Nile River Flow - Normal Probability Plot") + 
   xlab("x-axis") + ylab("y-axis")
```